import { useState } from "react";
import "./App.css";
import FileUpload from "./components/FileUpload";
import KeywordInput from "./components/KeywordInput";
import JobProfileSelector from "./components/JobProfileSelector";
import Results from "./components/Results";
import { filterResumes, downloadCSV } from "./services/api";
import type { FilterResponse } from "./types";
import logo from "./assets/logo.png";

function App() {
  const [files, setFiles] = useState<File[]>([]);
  const [keywords, setKeywords] = useState<string[]>([]);
  const [minScore, setMinScore] = useState<string>("");
  const [generateAiSummary, setGenerateAiSummary] = useState<boolean>(true);
  const [loading, setLoading] = useState<boolean>(false);
  const [results, setResults] = useState<FilterResponse | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [darkMode, setDarkMode] = useState<boolean>(false);
  const [selectedJobProfileName, setSelectedJobProfileName] = useState<string | null>(null);

  const handleFilesSelected = (selectedFiles: File[]) => {
    setFiles(selectedFiles);
    setError(null);
  };

  const handleKeywordsChange = (newKeywords: string[]) => {
    setKeywords(newKeywords);
  };

  const handleProfileSelect = (profileKeywords: string[], profileName?: string) => {
    setKeywords(profileKeywords);
    setSelectedJobProfileName(profileName || null);
    setError(null);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (files.length === 0) {
      setError("Please select at least one resume file");
      return;
    }

    if (keywords.length === 0) {
      setError("Please add at least one keyword");
      return;
    }

    setLoading(true);
    setError(null);
    setResults(null);

    try {
      const response = await filterResumes(
        files,
        keywords,
        minScore === "" ? 0 : Number(minScore),
        generateAiSummary,
      );

      // Set results to show the Results page
      setResults(response);
    } catch (err) {
      setError(
        err instanceof Error
          ? err.message
          : "An error occurred while processing resumes",
      );
      console.error("Error filtering resumes:", err);
    } finally {
      setLoading(false);
    }
  };

  const handleDownloadCSV = async () => {
    if (!results?.candidates || results.candidates.length === 0) return;

    try {
      const blob = await downloadCSV(results.candidates);
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `filtered_resumes_${new Date().toISOString().split("T")[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    } catch (err) {
      setError("Failed to download CSV file");
      console.error("Error downloading CSV:", err);
    }
  };

  const handleReset = () => {
    setFiles([]);
    setKeywords([]);
    setMinScore("");
    setGenerateAiSummary(true);
    setResults(null);
    setError(null);
    setSelectedJobProfileName(null);
  };

  return (
    <div className={`app ${darkMode ? "dark-mode" : ""}`}>
      <header className="app-header">
        <img
          className="app-logo"
          width="200"
          height="80"
          src={logo}
          alt="GCCLD Logo"
        />
        <div className="app-header-content">
          <h1>Gulf Contractors Resume Filter</h1>
          <p className="app-subtitle">
            Analyze and filter resumes based on keywords with AI-powered
            summaries
          </p>
        </div>
        <button
          className="dark-mode-toggle"
          onClick={() => setDarkMode(!darkMode)}
          aria-label="Toggle dark mode"
        >
          {darkMode ? "‚òÄÔ∏è" : "üåô"}
        </button>
      </header>

      <main className="app-main">
        {!results ? (
          <form onSubmit={handleSubmit} className="upload-form">
            <div className="form-section">
              <FileUpload onFilesSelected={handleFilesSelected} files={files} />
            </div>

            <div className="form-section">
              <JobProfileSelector
                onProfileSelect={handleProfileSelect}
                onError={setError}
              />
            </div>

            <div className="form-section">
              <KeywordInput
                keywords={keywords}
                onKeywordsChange={handleKeywordsChange}
              />
            </div>

            <div className="form-section">
              <div className="form-row">
                <div className="form-group">
                  <label htmlFor="minScore">Minimum Score</label>
                  <input
                    type="number"
                    id="minScore"
                    min="0"
                    max="100"
                    value={minScore}
                    onChange={(e) => setMinScore(e.target.value)}
                    className="score-input"
                    placeholder="0"
                  />
                  <p className="input-hint">
                    Filter resumes with score above this threshold (0-100)
                  </p>
                </div>

                <div className="form-group">
                  <label className="checkbox-label">
                    <input
                      type="checkbox"
                      checked={generateAiSummary}
                      onChange={(e) => setGenerateAiSummary(e.target.checked)}
                    />
                    <span>Generate AI Summary</span>
                  </label>
                  <p className="input-hint">
                    Enable OpenAI-powered resume summaries
                  </p>
                </div>
              </div>
            </div>

            {error && (
              <div className="error-message">
                <span className="error-icon">‚ö†Ô∏è</span>
                <span>{error}</span>
              </div>
            )}

            <div className="form-actions">
              <button type="submit" className="submit-btn" disabled={loading}>
                {loading ? "Processing..." : "Analyze Resumes"}
              </button>
            </div>
          </form>
        ) : (
          <>
            <Results
              results={results.candidates}
              totalResumes={results.total_resumes}
              passedResumes={results.valid_candidates}
              onDownloadCSV={handleDownloadCSV}
            />
            <div className="form-actions">
              <button onClick={handleReset} className="reset-btn">
                Analyze More Resumes
              </button>
            </div>
          </>
        )}
      </main>

      <footer className="app-footer">
        <p>¬© 2025 Gulf Contractors - Resume Filtering System</p>
      </footer>
    </div>
  );
}

export default App;

